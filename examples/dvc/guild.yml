- model: ''
  extra:
    dvc-stages-import:
      #- hello
      #- prepare-data
      #- train-models
      #- eval-models

  operations:

    # === hello variations =============================================

    hello-guild-op:
      description: Standard Guild dependency example without DvC support
      main: hello
      requires:
        - file: hello.in
          help: Missing hello.in - run 'dvc pull hello.in' to fetch it

    hello-dvc-dep:
      description: Uses DvC dependency to fetch required file if needed
      main: hello
      requires:
        - dvc: hello.in

    hello-dvc-dep-always-pull:
      description: Uses DvC dependency to always fetch required file
      main: hello
      requires:
        - dvc: hello.in
          always-pull: yes

    hello-dvc-stage:
      description: Uses Guild DvC plugin to run hello stage
      main: guild.plugins.dvc_stage_main hello

    # === faketrain ====================================================

    faketrain-guild-op:
      description: Run a training simulator for hyparam optimization
      main: faketrain
      run-attrs:
        dvc:stage: faketrain
      flags-dest: config:params.json.in
      flags-import:
        - x
        - noise

    faketrain-dvc-stage:
      description: Use Guild DvC plugin to run faketrain stage
      main: guild.plugins.dvc_stage_main faketrain
      run-attrs:
        dvc:stage: faketrain
      flags-dest: config:params.json.in
      flags-import:
        - x
        - noise

    # === prepare-data variations ======================================

    prepare-data-guild-op:
      description: Use Guild to run prepare-data operation
      main: prepare_data
      run-attrs:
          dvc:stage: prepare-data
      requires:
        - file: iris.csv
          help: Missing iris.csv - run 'dvc pull iris.csv' to fetch it

    prepare-data-dvc-dep:
      description: Use DvC dependency to fetch required file if needed
      main: prepare_data
      run-attrs:
          dvc:stage: prepare-data
      requires:
        - dvc: iris.csv

    prepare-data-dvc-stage:
      description: Use Guild DvC plugin to run prepare-data stage
      main: guild.plugins.dvc_stage_main prepare-data

    # === train-models variations ======================================

    train-models-guild-op:
      description: Use Guild to run the train models operation
      main: train_models
      flags-dest: config:params.json.in
      flags-import:
        - train.C
        - train.max-iters
        - train.gamma
      run-attrs:
          dvc:stage: train-models
      requires:
        - config: params.json.in
          rename: params.json.in params.json
        - operation: prepare-data-.*
          name: prepare-data
          select:
            - iris.npy

    train-models-dvc-stage:
      description: Use Guild DvC plugin to run train-models stage
      main: guild.plugins.dvc_stage_main train-models

    # === eval-models variations =======================================

    eval-models-guild-op:
      description: Use Guild to run the eval models operation
      main: eval_models
      flags-dest: config:params.json.in
      flags-import:
        - eval.plot-spacing
      run-attrs:
        dvc:stage: eval-models
      requires:
        - operation: prepare-data-.*
          select: iris.npy
          name: prepare-data
        - operation: train-models-.*
          select: model-.*\.joblib
          name: train-models

    eval-models-dvc-stage:
      description: Use Guild DvC plugin to run eval-models stage
      main: guild.plugins.dvc_stage_main eval-models
