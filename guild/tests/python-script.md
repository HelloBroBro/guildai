# Python Scripts

These tests cover similar topics to those in
[run-scripts](run-scripts.md).

Guild support running of Python scripts directly via the
`python_script` plugin.

We use the `python-script` sample project for these tests.

    >>> cd(sample("projects", "python-script"))

## Op data for Python scripts

The Python plugin examines Python scripts to infer operation
settings. We use the `_op_data_for_script` to illustrate.

    >>> from guild.plugins.python_script import _op_data_for_script

Helper function to print op data for a script along with any warnings
generated by the plugin:

    >>> def op_data(script):
    ...     _guildfile_dir, rel_script_path = guildfile.split_script_path(script)
    ...     with LogCapture() as log:
    ...         data = _op_data_for_script(script, rel_script_path)
    ...     if log:
    ...         log.print_all()
    ...     pprint(data)

Empty Python script:

    >>> op_data("empty.py")
    {'exec': '${python_exe} -um guild.op_main empty ${flag_args}',
     'flags': {},
     'flags-dest': 'globals',
     'objective': None,
     'output-scalars': None,
     'plugins': [],
     'sourcecode': None,
     'tags': None}

Simple script:

    >>> op_data("simple.py")
    {'exec': '${python_exe} -um guild.op_main simple ${flag_args}',
     'flags': {'layers': {'arg-split': None, 'default': 32, 'type': 'number'},
               'name': {'arg-split': None, 'default': 'foo', 'type': 'string'},
               'noise': {'arg-split': None, 'default': 3, 'type': 'number'},
               'skip_connections': {'arg-split': None,
                                    'default': True,
                                    'type': 'boolean'}},
     'flags-dest': 'globals',
     'objective': None,
     'output-scalars': None,
     'plugins': [],
     'sourcecode': None,
     'tags': None}

## Run Python scripts as Guild operations

Use a new Guild home to isolate runs.

    >>> set_guild_home(mkdtemp())

Simple script:

    >>> run("guild run simple.py -y")
    <exit 0>

    >>> run("guild runs info")
    id: ...
    operation: simple.py
    from: .../samples/projects/python-script
    status: completed
    started: ...
    stopped: ...
    marked: no
    label: layers=32 name=foo noise=3 skip_connections=yes
    sourcecode_digest: ...
    vcs_commit:...
    run_dir: ...
    command: ... -um guild.op_main simple --layers 32
             --name foo --noise 3 --skip_connections true
    exit_status: 0
    pid:
    tags:
    flags:
      layers: 32
      name: foo
      noise: 3
      skip_connections: yes
    scalars:
    <exit 0>

## Default tags

As of 0.9.1, Guild uses two default tags for Python scripts: 'model'
and 'dataset', which are used according to the script name.

If 'train' appears in the name, Guild assigns it the single tag
'model'. If the name contains 'prepare', Guild assigns it the single
tag 'dataset'.

This feature is to encourage the categorization of Python scripts in
View based on default **Models** and **Datasets** collections, which
filter based on the 'model' and 'dataset' tags respectively.

    >>> use_project(mkdtemp())

    >>> write("train.py", "print('Sample model')")

    >>> write("prepare.py", "print('Sample dataset')")

    >>> run("guild run train.py -y")
    Sample model
    <exit 0>

    >>> run("guild runs info")
    id: ...
    operation: train.py
    ...
    tags:
      - model
    flags:
    scalars:

    >>> run("guild run prepare.py -y")
    Sample dataset
    <exit 0>

    >>> run("guild runs info")
    id: ...
    operation: prepare.py
    ...
    tags:
      - dataset
    flags:
    scalars:
